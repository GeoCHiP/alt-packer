{
    "variables": {
        "packer_cache_dir": "{{env `PACKER_CACHE_DIR`}}",
        "target": "{{env `PACKER_TARGET`}}",
        "base_version": "{{env `PACKER_BASE_VERSION`}}",
        "arch": "{{env `PACKER_ARCH`}}",
        "headless": "{{env `PACKER_HEADLESS`}}",
        "target_version": "{{env `PACKER_TARGET_VERSION`}}",
        "apt_sources": "{{env `PACKER_APT_SOURCES`}}",
        "vm_type": "{{env `PACKER_VM_TYPE`}}",
        "root_password": "123",
        "vm_name_full": "{{env `PACKER_IMAGE_FILENAME`}}",
        "boot_escape_cmd": "<esc><wait><enter><wait>",
        "boot_finish_cmd": "<wait><enter>",
        "disk_size": "30000",
        "vcenter_server": "{{ env `PACKER_VCENTER_SERVER` }}",
        "vsphere_host": "{{ env `PACKER_VSPHERE_HOST` }}",
        "vsphere_user": "{{ env `PACKER_VSPHERE_USER` }}",
        "vsphere_pass": "{{ env `PACKER_VSPHERE_PASSWORD` }}",
        "openuds_actor_ssl_validation": "{{env `PACKER_OPENUDS_ACTOR_SSL_VALIDATION`}}",
        "openuds_host": "{{env `PACKER_OPENUDS_HOST`}}",
        "openuds_authenticator": "{{env `PACKER_OPENUDS_AUTHENTICATOR`}}",
        "openuds_username": "{{env `PACKER_OPENUDS_USERNAME`}}",
        "openuds_password": "{{env `PACKER_OPENUDS_PASSWORD`}}",
        "openuds_actor_pre_connect": "{{env `PACKER_OPENUDS_ACTOR_PRE_CONNECT`}}",
        "openuds_actor_run_once": "{{env `PACKER_OPENUDS_ACTOR_RUN_ONCE`}}",
        "openuds_actor_post_config": "{{env `PACKER_OPENUDS_ACTOR_POST_CONFIG`}}",
        "openuds_actor_log_level": "{{env `PACKER_OPENUDS_ACTOR_LOG_LEVEL`}}"
    },
    "sensitive-variables": ["openuds_actor_user", "openuds_actor_password"],

    "builders": [
        {
            "name": "qemu-vm",
            "type": "qemu",
            "format": "qcow2",
            "accelerator": "kvm",
            "vm_name": "{{ user `vm_name_full` }}.qcow2",
            "disk_size": "{{ user `disk_size` }}",
            "disk_cache": "unsafe",
            "disk_interface": "virtio-scsi",
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum` }}",
            "iso_checksum_type": "{{ user `iso_checksum_type` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "4s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                    "{{ user `boot_cmd` }} ",
                    "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
		        "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now"
        },

        {
            "name": "vagrant-qemu-vm",
            "type": "qemu",
            "format": "qcow2",
            "accelerator": "kvm",
            "vm_name": "{{ user `vm_name_full` }}.qcow2",
            "disk_size": "{{ user `disk_size` }}",
            "disk_cache": "unsafe",
            "disk_interface": "virtio-scsi",
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum` }}",
            "iso_checksum_type": "{{ user `iso_checksum_type` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "4s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                    "{{ user `boot_cmd` }} ",
                    "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
		        "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now"
        },

        {
            "name": "cloud-vm",
            "type": "qemu",
            "format": "qcow2",
            "accelerator": "kvm",
            "vm_name": "{{ user `vm_name_full` }}.qcow2",
            "disk_size": "{{ user `disk_size` }}",
            "disk_cache": "unsafe",
            "disk_interface": "virtio-scsi",
            "disk_discard": "unmap",
            "disk_detect_zeroes": "unmap",
            "disk_compression": true,
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum_type` }}:{{ user `iso_checksum` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "4s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                    "{{ user `boot_cmd` }} ",
                    "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
		        "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now"
        },

        {
            "name": "vsphere-vm",
            "type": "vsphere-iso",

            "vcenter_server": "{{ user `vcenter_server` }}",
            "username": "{{ user `vsphere_user` }}",
            "password": "{{ user `vsphere_pass` }}",
            "host": "{{  user `vsphere_host` }}",
            "insecure_connection": true,
            "network_adapters": [
                {
                    "network": "VM Network dhcp",
                    "network_card": "vmxnet3"
                }
            ],

            "export": {
                "force": true,
                "output_directory": "results",
                "manifest": "sha1"
            },

            "firmware": "efi",
            "vm_version": 14,
            "vm_name": "{{ user `vm_name_full` }}",
            "disk_size": "{{ user `disk_size` }}",
            "disk_controller_type": "pvscsi",
            "disk_thin_provisioned": true,
            "cpus": 1,
            "RAM": "{{ user `vm_mem` }}",
            "guest_os_type": "rhel8_64Guest",

            "iso_url": "{{ user `iso_url` }}",
            "iso_paths": [
                "{{ user `iso_datastore_path` }}"
            ],
            "iso_checksum": "{{ user `iso_checksum_type` }}:{{ user `iso_checksum` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "10s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                "{{ user `boot_cmd` }} ",
                "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
                "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now"
        },

        {
            "name": "onebula-vm",
            "type": "qemu",
            "format": "qcow2",
            "accelerator": "kvm",
            "vm_name": "{{ user `vm_name_full` }}.qcow2",
            "disk_size": "{{ user `disk_size` }}",
            "disk_cache": "unsafe",
            "disk_interface": "virtio-scsi",
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum` }}",
            "iso_checksum_type": "{{ user `iso_checksum_type` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "2s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                    "{{ user `boot_cmd` }} ",
                    "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
		        "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now"
        },

        {
            "name": "vbox-vm",
            "type": "virtualbox-iso",
            "format": "ova",
            "guest_os_type": "Linux_64",
            "vm_name": "{{ user `vm_name_full` }}",
            "disk_size": "{{ user `disk_size` }}",
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "keep_registered": false,
            "guest_additions_mode": "disable",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum` }}",
            "iso_checksum_type": "{{ user `iso_checksum_type` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "5s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                    "{{ user `boot_cmd` }} ",
                    "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
		        "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now",
            "post_shutdown_delay": "10s",

            "export_opts":
            [
                "--manifest",
                "--vsys", "0",
                "--description", "{{ user `descr` }}",
                "--version", "{{ user `image_version` }}"
            ]
        },

        {
            "name": "vagrant-vbox-vm",
            "type": "virtualbox-iso",
            "format": "ova",
            "guest_os_type": "Linux_64",
            "vm_name": "{{ user `vm_name_full` }}",
            "disk_size": "{{ user `disk_size` }}",
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "keep_registered": false,
            "guest_additions_mode": "disable",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",

            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum` }}",
            "iso_checksum_type": "{{ user `iso_checksum_type` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_wait_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "5s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                    "{{ user `boot_cmd` }} ",
                    "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
		        "{{ user `boot_finish_cmd` }}"
            ],

            "shutdown_command": "shutdown -P now",
            "post_shutdown_delay": "10s",

            "export_opts":
            [
                "--manifest",
                "--vsys", "0",
                "--description", "{{ user `descr` }}",
                "--version", "{{ user `image_version` }}"
            ]
        },

        {
            "name": "openuds-actor-vm",
            "type": "qemu",
            "format": "qcow2",
            "accelerator": "kvm",
            "vm_name": "{{ user `vm_name_full` }}.qcow2",
            "disk_size": "{{ user `disk_size` }}",
            "disk_cache": "unsafe",
            "disk_interface": "virtio-scsi",
            "output_directory": "results",
            "headless": "{{ user `headless` }}",
            "cpus": 1,
            "memory": "{{ user `vm_mem` }}",
            "iso_url": "{{ user `iso_url` }}",
            "iso_checksum": "{{ user `iso_checksum_type` }}:{{ user `iso_checksum` }}",
            "iso_target_path": "{{ user `packer_cache_dir` }}/{{ user `iso_target_path` }}",

            "http_port_min": "{{ user `http_port_min` }}",
            "http_port_max": "{{ user `http_port_max` }}",

            "ssh_username": "{{ user `ssh_user` }}",
            "ssh_password": "{{ user `ssh_pass` }}",
            "ssh_timeout": "60m",
            "ssh_pty": true,

            "http_directory": "./",

            "boot_wait": "4s",
            "boot_command": [
                "{{ user `boot_escape_cmd` }}<wait>",
                "{{ user `boot_cmd` }} ",
                "ai curl=http://{{.HTTPIP}}:{{.HTTPPort}}/metadata/{{ user `metadata` }}/ ",
                "{{ user `boot_finish_cmd` }}"
            ],
            "shutdown_command": "shutdown -P now"
        }

    ],

    "provisioners": [
        {
            "type": "file",
            "source": "scripts/",
            "destination": "/tmp/.private/root/"
        },
        {
            "type": "shell",
            "remote_folder": "/tmp/.private/root/",
            "script": "scripts/vm_setup",
            "environment_vars": [
                "ROOT_PASS={{ user `root_password` }}",
                "PASS='{{ user `ssh_pass` }}'",
                "SSH_USER='{{ user `ssh_user` }}'",
                "VM_TYPE={{ user `vm_type` }}",
                "BASE_VERSION={{ user `base_version` }}",
                "TARGET={{ user `target` }}",
                "TARGET_REPOS={{ user `target_version` }}",
                "ARCH={{ user `arch` }}",
                "CLOUDINIT={{ user `with_cloudinit` }}",
                "SISYPHUS={{ user `with_sisyphus` }}",
                "OPENUDS_ACTOR_SSL_VALIDATION={{ user `openuds_actor_ssl_validation` }}",
                "OPENUDS_HOST={{ user `openuds_host` }}",
                "OPENUDS_AUTHENTICATOR={{ user `openuds_authenticator` }}",
                "OPENUDS_USERNAME={{ user `openuds_username` }}",
                "OPENUDS_PASSWORD={{ user `openuds_password` }}",
                "OPENUDS_ACTOR_PRE_CONNECT={{ user `openuds_actor_pre_connect` }}",
                "OPENUDS_ACTOR_RUN_ONCE={{ user `openuds_actor_run_once` }}",
                "OPENUDS_ACTOR_POST_CONFIG={{ user `openuds_actor_post_config` }}",
                "OPENUDS_ACTOR_LOG_LEVEL={{ user `openuds_actor_log_level` }}"
            ]
        }
    ],
    "post-processors": [
        {
            "type": "checksum",
            "checksum_types": [ "md5", "sha1" ],
            "output": "results/{{ user `vm_name_full` }}.{{.ChecksumType}}"
        },
        {
            "type": "vagrant",
            "output": "results/{{ user `vm_name_full` }}.box",
            "only": [ "vagrant-qemu-vm", "vagrant-vbox-vm" ]
        },
        {
            "type": "manifest",
            "output": "results/manifest.json",
            "strip_path": true
        }
    ]
}
